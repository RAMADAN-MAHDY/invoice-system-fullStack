<%- include('partials/header') %>

<div class="container mx-auto p-0 sm:p-2 lg:p-6">
    <div class="glass p-2 lg:p-6 rounded-lg shadow-lg">

        <h1 class="text-3xl font-bold text-center mb-6 text-white">ğŸ“œ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h1>

        <% if (typeof error !=='undefined' && error) { %>
            <div class="bg-red-900/50 text-red-400 p-3 rounded mb-4 text-center">
                <%= error %>
            </div>
        <% } %>

        <!-- ğŸ” ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
        <form method="GET" action="/sales" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 items-end">
            <div>
                <label class="block font-semibold mb-1 text-gray-300">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" name="from" value="<%= from %>" class="w-full bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg" />
            </div>

            <div>
                <label class="block font-semibold mb-1 text-gray-300">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" name="to" value="<%= to %>" class="w-full bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg" />
            </div>

            <div class="flex items-center space-x-2 rtl:space-x-reverse">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg w-full hover:bg-blue-700 transition">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
                <a href="/sales/export<% if (from || to) { %>?from=<%= from %>&to=<%= to %><% } %>"
                   class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 w-full text-center transition">
                    ğŸ“¤ ØªØµØ¯ÙŠØ± Excel
                </a>
            </div>
        </form>

        <!-- Ø²Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
        <div class="flex space-x-2 rtl:space-x-reverse mb-4">
            <button id="openModal" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯
            </button>
            <button id="bulkDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition hidden">
                ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
            </button>
        </div>

        <!-- ğŸ§¾ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± -->
        <div class="overflow-x-auto">
            <table class="w-full border-collapse text-sm sm:text-base">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="p-3 text-center">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th class="p-3 text-center">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
                        <th class="p-3 text-center">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
                        <th class="p-3 text-center">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ù‡</th>
                        <th class="p-3 text-center">Ø§Ù„Ø¹Ø¯Ø¯</th>
                        <th class="p-3 text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th class="p-3 text-center">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±</th>
                        <th class="p-3 text-center">ØªØ­Ø¯ÙŠØ¯</th>
                        <th class="p-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (sales.length===0) { %>
                        <tr class="border-b border-gray-800">
                            <td colspan="8" class="text-center text-gray-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td>
                        </tr>
                    <% } else { %>
                        <% sales.forEach(sale=> { %>
                            <tr class="border-b border-gray-800 hover:bg-gray-700">
                                <td class="p-3 text-center">
                                    <%= sale.createdAt ? sale.createdAt.toISOString().slice(0,10) : '' %>
                                </td>
                                <td class="p-3 text-center">
                                    <%= sale.modelNumber %>
                                </td>
                                <td class="p-3 text-center">
                                    <%= sale.sellerName || "" %>
                                </td>
                                <td class="p-3 text-center">
                                    <%= sale.name %>
                                </td>
                                <td class="p-3 text-center">
                                    <%= sale.quantity %>
                                </td>
                                <td class="p-3 text-center">
                                    <%= sale.price %>
                                </td>
                                <td class="p-3 text-center font-semibold text-green-400">
                                    <%= sale.total %>
                                </td>
                                <td class="p-3 text-center">
                                    <input type="checkbox" class="sale-checkbox" value="<%= sale._id %>">
                                </td>
                                <td class="p-3 text-center">
                                    <button class="bg-blue-500 text-white px-2 py-1 mb-2 rounded hover:bg-blue-600" onclick="openEditModal('<%= sale._id %>')">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" onclick="deleteSale('<%= sale._id %>')">Ø­Ø°Ù</button>
                                </td>
                            </tr>
                        <% }); %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Modal) -->
<div id="saleModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="glass rounded-lg shadow-lg w-11/12 max-w-md p-6 relative">
        <button id="closeModal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-6 text-center text-white">ğŸ§¾ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©</h2>

        <!-- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ -->
        <input id="searchInput" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„"
               class="w-full bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg mb-3 text-right focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <ul id="results" class="mt-2 bg-gray-800 border border-gray-700 rounded-lg shadow hidden max-h-40 overflow-y-auto"></ul>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ÙŠØ¹ -->
        <form id="saleForm" class="space-y-4 hidden mt-4">
            <div>
                <label class="block font-semibold text-gray-300">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                <input type="text" id="modelNumber" class="w-full bg-gray-700 border border-gray-600 px-3 py-2 rounded-lg" readonly />
            </div>

            <div>
                <label class="block font-semibold text-gray-300">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Customer Name)</label>
                <input type="text" id="customerName" name="customerName" class="w-full bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
            </div>

            <div>
                <label class="block font-semibold text-gray-300">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                <input type="text" id="name" class="w-full bg-gray-700 border border-gray-600 px-3 py-2 rounded-lg" />
            </div>

            <div>
                <label class="block font-semibold text-gray-300">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                <input type="number" id="price" class="w-full bg-gray-700 border border-gray-600 px-3 py-2 rounded-lg" />
            </div>

            <div>
                <label class="block font-semibold text-gray-300">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                <input type="number" id="quantity" min="1" class="w-full bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg" />
            </div>

            <div>
                <label class="block font-semibold text-gray-300">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Total)</label>
                <input type="number" id="total" name="frontTotal" class="w-full bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg" placeholder="Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§" />
            </div>

            <button type="button" id="sellBtn" class="bg-green-600 text-white font-bold px-4 py-2 rounded-lg w-full hover:bg-green-700 transition">
                ğŸ’° ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹
            </button>
        </form>
    </div>
</div>

<!-- Edit Sale Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="glass rounded-lg shadow-lg w-11/12 max-w-md p-6 relative">
        <button onclick="closeEditModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-6 text-center text-white">ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹</h2>
        <form id="editForm" class="space-y-4">
            <input type="hidden" id="editSaleId">
            <div>
                <label class="block font-semibold text-gray-300">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <input type="number" id="editQuantity" class="w-full bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg" min="1">
            </div>
            <div>
                <label class="block font-semibold text-gray-300">Ø§Ù„Ø³Ø¹Ø±</label>
                <input type="number" id="editPrice" class="w-full bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg" min="0">
            </div>
            <button type="button" onclick="submitEdit()" class="bg-green-600 text-white font-bold px-4 py-2 rounded-lg w-full hover:bg-green-700 transition">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </form>
    </div>
</div>

<script>
    const token = "<%= token %>";
    const salesData = <%- JSON.stringify(sales || []) %>;

    // Sale Modal
    const saleModal = document.getElementById('saleModal');
    document.getElementById('openModal').addEventListener('click', () => saleModal.classList.remove('hidden'));
    document.getElementById('closeModal').addEventListener('click', () => saleModal.classList.add('hidden'));

    // Edit Modal
    const editModal = document.getElementById('editModal');
    function openEditModal(saleId) {
        const sale = salesData.find(s => s._id === saleId);
        if (sale) {
            document.getElementById('editSaleId').value = sale._id;
            document.getElementById('editQuantity').value = sale.quantity;
            document.getElementById('editPrice').value = sale.price;
            editModal.classList.remove('hidden');
        }
    }
    function closeEditModal() {
        editModal.classList.add('hidden');
    }

    // Search Products
    document.getElementById("searchInput").addEventListener("input", async function () {
        const q = this.value.trim();
        const resultsBox = document.getElementById("results");
        if (!q) {
            resultsBox.innerHTML = "";
            resultsBox.classList.add("hidden");
            return;
        }
        try {
            const res = await fetch(`/api/items/search?search=${q}`, { headers: { Authorization: `Bearer ${token}` } });
            const data = await res.json();
            if (!data.status || !data.data.length) {
                resultsBox.innerHTML = "<li class='px-3 py-2 text-gray-400'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</li>";
            } else {
                resultsBox.innerHTML = data.data.map(item =>
                    `<li data-item='${JSON.stringify(item)}' class='px-3 py-2 cursor-pointer hover:bg-gray-700'>
                        ${item.name} (${item.modelNumber}) - ${item.quantity} available
                    </li>`
                ).join("");
            }
            resultsBox.classList.remove("hidden");
        } catch (err) {
            resultsBox.innerHTML = "<li class='px-3 py-2 text-red-400'>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</li>";
            resultsBox.classList.remove("hidden");
        }
    });

    // Select Product from Search
    document.getElementById("results").addEventListener("click", function (e) {
        if (e.target.tagName === "LI" && e.target.dataset.item) {
            const item = JSON.parse(e.target.dataset.item);
            document.getElementById("saleForm").classList.remove("hidden");
            document.getElementById("modelNumber").value = item.modelNumber;
            document.getElementById("customerName").value = item.sellerName;
            document.getElementById("name").value = item.name;
            document.getElementById("price").value = item.price;
            document.getElementById("quantity").max = item.quantity;
            document.getElementById("results").classList.add("hidden");
            calculateTotal();
        }
    });

    // Calculate Total
    const priceInput = document.getElementById("price");
    const quantityInput = document.getElementById("quantity");
    const totalInput = document.getElementById("total");
    function calculateTotal() {
        const price = parseFloat(priceInput.value) || 0;
        const quantity = parseInt(quantityInput.value) || 0;
        totalInput.value = (price * quantity).toFixed(2);
    }
    priceInput.addEventListener("input", calculateTotal);
    quantityInput.addEventListener("input", calculateTotal);

    // Add Sale
    document.getElementById("sellBtn").addEventListener("click", async function () {
        const saleData = {
            modelNumber: document.getElementById("modelNumber").value,
            sellerName: document.getElementById("customerName").value,
            name: document.getElementById("name").value,
            price: parseFloat(priceInput.value),
            quantity: parseInt(quantityInput.value),
            frontTotal: parseFloat(totalInput.value),
        };

        if (!saleData.modelNumber || !saleData.name || !saleData.price || !saleData.quantity) {
            return Swal.fire({
                icon: 'warning',
                title: 'Ø®Ø·Ø£',
                text: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        }

        try {
            const res = await fetch("/api/sales", {
                method: "POST",
                headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                body: JSON.stringify(saleData),
            });
            
            const result = await res.json();
            console.log(result);
            if (result.status) {
                Swal.fire({
                    icon: 'success',
                    title: 'Ù†Ø¬Ø§Ø­',
                    text: 'ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!',
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                });
                window.location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'ÙØ´Ù„',
                    text: 'ÙØ´Ù„ Ø§Ù„Ø¨ÙŠØ¹: ' + result.message,
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£',
                text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        }
    });

    // Edit Sale
    async function submitEdit() {
        const saleId = document.getElementById('editSaleId').value;
        const quantity = document.getElementById('editQuantity').value;
        const price = document.getElementById('editPrice').value;

        try {
            const res = await fetch(`/api/sales/${saleId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ quantity, price })
            });
            const result = await res.json();
            if (result.status) {
                Swal.fire({
                icon: 'success',
                title: 'Ù†Ø¬Ø§Ø­',
                text: 'ØªÙ… ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
                window.location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'ÙØ´Ù„',
                    text: 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹: ' + result.message,
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£',
                text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        }
    }



    // Delete Sale
    async function deleteSale(saleId) {
        Swal.fire({
            title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
            text: 'Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§!',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/sales/${saleId}`, {
                        method: 'DELETE',
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const result = await res.json();
                    if (result.status) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                            text: 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.',
                            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                        });
                        window.location.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù',
                            text: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + result.message,
                            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                        });
                    }
                } catch (err) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ø®Ø·Ø£',
                        text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….',
                        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                    });
                }
            }
        });
    }

    function openEditModal(saleId) {
        const sale = salesData.find(s => s._id === saleId);
        if (sale) {
            document.getElementById('editSaleId').value = sale._id;
            document.getElementById('editQuantity').value = sale.quantity;
            document.getElementById('editPrice').value = sale.price;
            document.getElementById('editModal').classList.remove('hidden');
        }
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    async function submitEdit() {
        const saleId = document.getElementById('editSaleId').value;
        const quantity = document.getElementById('editQuantity').value;
        const price = document.getElementById('editPrice').value;

        try {
            const res = await fetch(`/api/sales/${saleId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ quantity, price })
            });
            const result = await res.json();
            if (result.status) {
                Swal.fire({
                icon: 'success',
                title: 'Ù†Ø¬Ø§Ø­',
                text: 'ØªÙ… ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
                window.location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'ÙØ´Ù„',
                    text: 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹: ' + result.message,
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£',
                text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        }
    }

    async function deleteSale(saleId) {
        Swal.fire({
            title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
            text: 'Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§!',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/sales/${saleId}`, {
                        method: 'DELETE',
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const result = await res.json();
                    if (result.status) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                            text: 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.',
                            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                        });
                        window.location.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù',
                            text: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + result.message,
                            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                        });
                    }
                } catch (err) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ø®Ø·Ø£',
                        text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….',
                        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                    });
                }
            }
        });
    }

    // Bulk Delete Logic
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const saleCheckboxes = document.querySelectorAll('.sale-checkbox');

    saleCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', toggleBulkDeleteButton);
    });

    function toggleBulkDeleteButton() {
        const checkedCheckboxes = document.querySelectorAll('.sale-checkbox:checked');
        if (checkedCheckboxes.length > 0) {
            bulkDeleteBtn.classList.remove('hidden');
        } else {
            bulkDeleteBtn.classList.add('hidden');
        }
    }

    bulkDeleteBtn.addEventListener('click', async () => {
        const checkedCheckboxes = document.querySelectorAll('.sale-checkbox:checked');
        const saleIdsToDelete = Array.from(checkedCheckboxes).map(cb => cb.value);

        if (saleIdsToDelete.length === 0) {
            alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø°Ù.');
            return;
        }

        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${saleIdsToDelete.length} ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ø¯Ø¯Ø©ØŸ`)) return;

        try {
            const res = await fetch('/api/sales/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ ids: saleIdsToDelete })
            });
            const result = await res.json();
            if (result.status) {
                Swal.fire({
                    icon: 'success',
                    title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                    text: 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.',
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                });
                window.location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù',
                    text: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ: ' + result.message,
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£',
                text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        }
    });
</script>

<%- include('partials/footer') %>