<%- include('partials/header') %>
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

    <div class="glass rounded-xl shadow-lg p-6 md:p-8">
        <div class="mb-6">
            <input type="text" id="searchBar" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." 
                   class="w-full px-4 py-3 bg-gray-200 border-gray-400 rounded-lg text-black placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" 
                   autofocus>
            <div id="searchLoading" style="display:none;" class="text-center text-gray-300 mt-2"><span class="animate-spin">ğŸ”„</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>

        <button type="button" id="showAddFormBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold px-5 py-2 rounded-lg mb-6 transition-transform transform hover:scale-105">
            Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>

        <form id="invoiceForm" class="space-y-5 p-6 bg-gray-800/30 rounded-lg border border-gray-700" style="display:none;">
            <div>
                <label class="block font-semibold text-gray-200 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                <input type="text" id="modelNumber" name="modelNumber" class="w-full px-4 py-2 bg-gray-200 border-gray-400 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label class="block font-semibold text-gray-200 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                <input type="text" id="customer" name="customer" class="w-full px-4 py-2 bg-gray-200 border-gray-400 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label class="block font-semibold text-gray-200 mb-1">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                <input type="text" id="itemName" name="itemName" class="w-full px-4 py-2 bg-gray-200 border-gray-400 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold text-gray-200 mb-1">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                    <input type="number" id="quantity" name="quantity" class="w-full px-4 py-2 bg-gray-200 border-gray-400 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500" required min="1">
                </div>
                <div>
                    <label class="block font-semibold text-gray-200 mb-1">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                    <input type="number" id="price" name="price" class="w-full px-4 py-2 bg-gray-200 border-gray-400 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500" required min="0">
                </div>
            </div>
            <div>
                <label class="block font-semibold text-gray-200 mb-1">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
                <input type="text" id="totalPrice" class="w-full px-4 py-2 border border-gray-700 rounded-lg bg-gray-800 text-gray-400 font-bold" readonly>
            </div>
            <div class="flex gap-4 pt-4">
                <button type="button" id="saveBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded-lg transition">Ø­ÙØ¸</button>
                <button type="button" id="cancelFormBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold px-6 py-2 rounded-lg transition">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </form>

        <h3 class="text-2xl font-bold text-white mt-8 mb-4">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
        <div class="overflow-x-auto glass rounded-lg border border-gray-700">
            <table class="w-full table-auto">
                <thead>
                    <tr class="border-b border-gray-700">
                        <th colspan="5" class="text-right font-bold text-gray-200 p-4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†:</th>
                        <th id="grandTotal" class="font-bold text-green-400 text-lg p-4">0</th>
                        <th></th>
                    </tr>
                    <tr class="bg-gray-800/80">
                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-100 uppercase tracking-wider">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-100 uppercase tracking-wider">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-100 uppercase tracking-wider">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-100 uppercase tracking-wider">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-100 uppercase tracking-wider">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-100 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-100 uppercase tracking-wider">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="recentInvoices" class="divide-y divide-gray-700">
                    <% invoices.forEach(inv=> { %>
                    <tr data-id="<%= inv._id %>" class="hover:bg-gray-800/40 transition">
                        <td class="px-4 py-3 whitespace-nowrap text-gray-100"><%= inv.modelNumber %></td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-100"><%= inv.customer %></td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-100"><%= inv.name %></td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-100"><%= inv.quantity %></td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-100"><%= inv.price %></td>
                        <td class="px-4 py-3 whitespace-nowrap text-green-400 font-semibold"><%= inv.quantity * inv.price %></td>
                        <td class="px-4 py-3 whitespace-nowrap flex gap-2">
                            <button type="button" class="editBtn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-xs font-semibold transition">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button type="button" class="deleteBtn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-xs font-semibold transition">Ø­Ø°Ù</button>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const quantityInput = document.getElementById('quantity');
const priceInput = document.getElementById('price');
const totalPriceInput = document.getElementById('totalPrice');
const invoiceForm = document.getElementById('invoiceForm');
const saveBtn = document.getElementById('saveBtn');
const recentInvoices = document.getElementById('recentInvoices');
const grandTotal = document.getElementById('grandTotal');

function calcTotal() {
    const qty = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    totalPriceInput.value = (qty * price).toFixed(2);
}

quantityInput.addEventListener('input', calcTotal);
priceInput.addEventListener('input', calcTotal);

document.getElementById('showAddFormBtn').onclick = () => {
    invoiceForm.style.display = 'block';
    invoiceForm.removeAttribute('data-edit-id');
    invoiceForm.reset();
    calcTotal();
};

document.getElementById('cancelFormBtn').onclick = () => {
    invoiceForm.style.display = 'none';
    invoiceForm.removeAttribute('data-edit-id');
};

function editRow() {
    const row = this.closest('tr');
    const cells = row.children;
    document.getElementById('modelNumber').value = cells[0].innerText;
    document.getElementById('customer').value = cells[1].innerText;
    document.getElementById('itemName').value = cells[2].innerText;
    document.getElementById('quantity').value = cells[3].innerText;
    document.getElementById('price').value = cells[4].innerText;
    calcTotal();
    invoiceForm.setAttribute('data-edit-id', row.getAttribute('data-id'));
    invoiceForm.style.display = 'block';
    window.scrollTo({ top: invoiceForm.offsetTop - 100, behavior: 'smooth' });
}

function deleteRow() {
    const row = this.closest('tr');
    const id = row.getAttribute('data-id');
    if (!id) {
        console.error('Delete failed: Missing data-id attribute');
        Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù†ØµØ±.', 'error');
        return;
    }
    Swal.fire({
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
        text: 'Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡!',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/items/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer <%= token %>' } })
            .then(res => res.json())
            .then(data => {
                if (data.status) {
                    row.remove();
                    updateGrandTotal();
                    Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù!', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                } else {
                    Swal.fire('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', data.message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
                }
            }).catch(() => {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….', 'error');
            });
        }
    });
}

function updateGrandTotal() {
    let total = 0;
    recentInvoices.querySelectorAll('tr').forEach(row => {
        const totalCell = row.children[5];
        total += parseFloat(totalCell.innerText) || 0;
    });
    grandTotal.innerText = total.toFixed(2);
}

function bindRowEvents(row) {
    row.querySelector('.editBtn').addEventListener('click', editRow);
    row.querySelector('.deleteBtn').addEventListener('click', deleteRow);
}

recentInvoices.querySelectorAll('tr').forEach(bindRowEvents);

saveBtn.onclick = async () => {
    const body = {
        modelNumber: document.getElementById('modelNumber').value,
        customer: document.getElementById('customer').value,
        name: document.getElementById('itemName').value,
        quantity: parseFloat(document.getElementById('quantity').value),
        price: parseFloat(document.getElementById('price').value),
    };

    const editId = invoiceForm.getAttribute('data-edit-id');
    let url = '/api/items', method = 'POST';
    if (editId) { url = `/api/items/${editId}`; method = 'PUT'; }

    try {
        const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer <%= token %>' },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) return Swal.fire('Ø®Ø·Ø£', data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.', 'error');

        invoiceForm.removeAttribute('data-edit-id');
        invoiceForm.style.display = 'none';

        const item = data.item || body;
        item._id = data.item?._id || editId;

        if (editId) {
            const row = recentInvoices.querySelector(`tr[data-id="${editId}"]`);
            row.children[0].innerText = item.modelNumber;
            row.children[1].innerText = item.customer;
            row.children[2].innerText = item.name;
            row.children[3].innerText = item.quantity;
            row.children[4].innerText = item.price.toFixed(2);
            row.children[5].innerText = (item.quantity * item.price).toFixed(2);
        } else {
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-id', item._id);
            newRow.className = 'hover:bg-gray-800/40 transition';
            newRow.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-gray-100">${item.modelNumber}</td>
                <td class="px-4 py-3 whitespace-nowrap text-gray-100">${item.customer}</td>
                <td class="px-4 py-3 whitespace-nowrap text-gray-100">${item.name}</td>
                <td class="px-4 py-3 whitespace-nowrap text-gray-100">${item.quantity}</td>
                <td class="px-4 py-3 whitespace-nowrap text-gray-100">${item.price.toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-green-400 font-semibold">${(item.quantity * item.price).toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap flex gap-2">
                    <button type="button" class="editBtn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-xs font-semibold transition">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button type="button" class="deleteBtn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-xs font-semibold transition">Ø­Ø°Ù</button>
                </td>`;
            recentInvoices.appendChild(newRow);
            bindRowEvents(newRow);
        }

        updateGrandTotal();
    } catch(err) {
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ø®Ø§Ø¯Ù….');
        console.error(err);
    }
};

updateGrandTotal();
</script>

<%- include('partials/footer') %>